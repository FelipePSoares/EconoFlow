<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <app-return-button (returnButtonEvent)="previous()"></app-return-button>

        <h2 class="text-center flex-grow-1 m-0">{{ categoryName$ | async }}</h2>

        <app-current-date (dateUpdatedEvent)="updateDate($event)"></app-current-date>
      </div>

      <mat-card class="mb-4">
        <mat-card-content [class.archived-container]="isArchived">
          <div class="list-group list-group-flush">
            @for (expense of (expenses$ | async); track expense.id) {
              <div class="list-group-item">
                @if (isEditingExpense(expense)) {
                  <app-expense
                    [projectId]="projectId"
                    [categoryId]="categoryId"
                    [expense]="expense"
                    [inlineMode]="true"
                    (saved)="onExpenseSaved()"
                    (canceled)="cancelExpenseForm()">
                  </app-expense>
                } @else {
                  <div class="d-flex align-items-center expense-item">
                    @if(canAddOrEdit() || (expense.items && expense.items.length > 0)) {
                      <button class="btn btn-link p-0 me-3"
                        (click)="toggleExpand(expense.id)"
                        [attr.aria-expanded]="isExpanded(expense.id)">
                        <i class="bi" [class]="isExpanded(expense.id) ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                      </button>
                    }

                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-1 fw-bold name mb-3" [class.archived]="isArchived">{{ expense.name }}</h2>

                        @if (canAddOrEdit()) {
                          <div class="btn-group">
                            <button name="edit" class="btn btn-outline-secondary" (click)="startEditExpense(expense)">
                              <i class="bi bi-pencil-square"></i>
                            </button>
                            <button name="delete" class="btn btn-outline-danger" (click)="triggerDelete(expense)">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        }
                      </div>

                      <div [class.archived]="isArchived">
                        <app-budget-bar [spend]="expense.getSpend()"
                          [budget]="expense.budget"
                          [overspend]="expense.getOverspend()"
                          [remaining]="expense.getRemaining()"
                          [date]="expense?.items && expense.items.length > 0 ? undefined : expense.date">
                        </app-budget-bar>
                      </div>
                    </div>
                  </div>
                }

                @if (isExpanded(expense.id)) {
                  <div class="sublist mt-2 ms-4 border-top pt-2" [class.archived]="isArchived">
                    @for (subExpense of expense.items; track subExpense.id) {
                      @if (isEditingSubExpense(expense, subExpense)) {
                        <app-expense-item
                          [projectId]="projectId"
                          [categoryId]="categoryId"
                          [parentExpense]="expense"
                          [expenseItem]="subExpense"
                          [inlineMode]="true"
                          (saved)="onSubExpenseSaved()"
                          (canceled)="cancelSubExpenseForm()">
                        </app-expense-item>
                      } @else {
                        <div class="d-flex align-items-center mb-2">
                          <div class="flex-grow-1">
                            @if (subExpense.name && subExpense.name.trim()) {
                              <span class="fw-normal name-sub">{{ subExpense.name }}</span>
                            } @else {
                              <span class="fw-normal text-muted fst-italic name-sub-placeholder">{{ 'PlaceholderItemWithoutName' | translate }}</span>
                            }

                            <p class="text-muted fs-6 mb-1">
                              <span class="me-3 date-sub">
                                <i class="bi bi-calendar me-1"></i>
                                {{ subExpense.date | date: 'shortDate' : undefined : currentLanguage }}
                              </span>
                              <span class="text-nowrap amount-sub">
                                <i class="bi bi-cash-coin me-1"></i>
                                {{ subExpense.amount | currencyFormat }}
                              </span>
                            </p>
                          </div>

                          @if (canAddOrEdit()) {
                            <div class="btn-group btn-group-sm">
                              <button name="edit-sub" class="btn btn-outline-secondary" (click)="startEditSubExpense(expense, subExpense)">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button name="delete-sub" class="btn btn-outline-danger" (click)="triggerDeleteSubExpense(expense, subExpense)">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          }
                        </div>
                      }
                    }

                    @if (isCreatingSubExpense(expense)) {
                      <app-expense-item
                        [projectId]="projectId"
                        [categoryId]="categoryId"
                        [parentExpense]="expense"
                        [inlineMode]="true"
                        (saved)="onSubExpenseSaved()"
                        (canceled)="cancelSubExpenseForm()">
                      </app-expense-item>
                    }

                    @if (canAddExpenseItem() && !isCreatingSubExpense(expense)) {
                      <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" (click)="startCreateSubExpense(expense)">
                          <i class="bi bi-plus me-1"></i>
                          {{ 'ButtonAddItem' | translate }}
                        </button>
                      </div>
                    }
                  </div>
                }
              </div>
            }

            @if (isCreatingExpense) {
              <div class="list-group-item text-center">
                <app-expense
                  [projectId]="projectId"
                  [categoryId]="categoryId"
                  [inlineMode]="true"
                  (saved)="onExpenseSaved()"
                  (canceled)="cancelExpenseForm()">
                </app-expense>
              </div>
            }

            @if (canCreateExpense() && !isCreatingExpense) {
              <div class="list-group-item text-center">
                <button class="btn btn-primary btn-add btn-lg w-100 d-flex justify-content-center align-items-center"
                  (click)="startCreateExpense()">
                  <i class="bi bi-plus me-2"></i>
                  {{ 'ButtonAddExpense' | translate }}
                </button>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
